# https://github.com/Yelp/dumb-init/releases
ARG DUMB_INIT_VERSION=1.2.5

# Build container
FROM node:20.13.1 AS build
ARG DUMB_INIT_VERSION

WORKDIR /home/node

ARG DATABASE_URL
ENV DATABASE_URL=${DATABASE_URL}

ARG NEXT_PUBLIC_GDPR_SECRET_KEY
ENV NEXT_PUBLIC_GDPR_SECRET_KEY=${NEXT_PUBLIC_GDPR_SECRET_KEY}

ARG NEXT_PUBLIC_GDPR_SECRET_IV
ENV NEXT_PUBLIC_GDPR_SECRET_IV=${NEXT_PUBLIC_GDPR_SECRET_IV}

ARG NEXT_PUBLIC_TINY_MCE_API_KEY
ENV NEXT_PUBLIC_TINY_MCE_API_KEY=${NEXT_PUBLIC_TINY_MCE_API_KEY}

ARG FALCON_API_URL
ENV FALCON_API_URL={FALCON_API_URL}

ARG CIMET_API_KEY
ENV CIMET_API_KEY={CIMET_API_KEY}

RUN wget -O dumb-init -q https://github.com/Yelp/dumb-init/releases/download/v${DUMB_INIT_VERSION}/dumb-init_${DUMB_INIT_VERSION}_aarch64
RUN chmod +x dumb-init
ADD . /home/node

RUN yarn install && yarn build && yarn cache clean

# Runtime container
FROM node:20.13.1 AS runner

WORKDIR /home/node

ARG PORT
ENV PORT=${PORT}

ARG NEXT_PUBLIC_GDPR_SECRET_KEY
ENV NEXT_PUBLIC_GDPR_SECRET_KEY=${NEXT_PUBLIC_GDPR_SECRET_KEY}

ARG NEXT_PUBLIC_GDPR_SECRET_IV
ENV NEXT_PUBLIC_GDPR_SECRET_IV=${NEXT_PUBLIC_GDPR_SECRET_IV}

ARG NEXT_PUBLIC_TINY_MCE_API_KEY
ENV NEXT_PUBLIC_TINY_MCE_API_KEY=${NEXT_PUBLIC_TINY_MCE_API_KEY}

COPY --from=build /home/node /home/node

EXPOSE ${PORT}

CMD ["./dumb-init", "yarn", "start"]
